<html>
<head>
  <title>Box2dWeb example</title>
</head>
<body onload="init();">
<div style="position:absolute;"><img src="back.png"/>
</div>
<canvas style="border:1px solid black;position:absolute;" id="canvas" width="830" height="500"></canvas>
</body>
<script type="text/javascript" src="Box2dWeb-2.1.a.3.min.js"></script>
<script type="text/javascript">
  var verts = [
    [163, 200],
    [165, 224],
    [186, 252],
    [187, 269],
    [208, 335],
    [223, 351],
    [242, 350],
    [262, 338],
    [276, 345],
    [218, 402],
    [192, 377],
    [181, 371],
    [147, 293],
    [130, 270],
    [85, 376],
    [95, 391],
    [113, 390],
    [118, 401],
    [91, 410],
    [40, 402],
    [49, 360],
    [83, 280],
    [46, 234],
    [40, 218],
    [40, 198],
    [40, 140],
    [77, 65],
    [111, 48],
    [133, 48],
    [137, 40],
    [145, 40],
    [164, 10],
    [186, 7],
    [212, 19],
    [211, 28],
    [206, 32],
    [200, 50],
    [202, 61],
    [191, 77],
    [173, 74],
    [167, 79],
    [174, 94],
    [181, 107],
    [183, 123],
    [190, 136],
    [207, 145],
    [286, 120],
    [298, 135],
    [296, 144],
    [275, 150],
    [270, 169],
    [200, 183],
    [172, 172],
    [162, 200]
  ];

  var world;
  var canvas = document.getElementById( 'canvas' );
  var context = canvas.getContext( '2d' );

  var bodies = [];

  var b2Vec2 = Box2D.Common.Math.b2Vec2, b2BodyDef = Box2D.Dynamics.b2BodyDef, b2Body = Box2D.Dynamics.b2Body, b2FixtureDef = Box2D.Dynamics.b2FixtureDef, b2Fixture = Box2D.Dynamics.b2Fixture, b2World = Box2D.Dynamics.b2World, b2MassData = Box2D.Collision.Shapes.b2MassData, b2PolygonShape = Box2D.Collision.Shapes.b2PolygonShape, b2CircleShape = Box2D.Collision.Shapes.b2CircleShape, b2DebugDraw = Box2D.Dynamics.b2DebugDraw;


  function init() {

    world = new b2World( new b2Vec2( 0, 0 )//gravity
        , true //allow sleep
    );

    var fixDef = new b2FixtureDef();
    fixDef.density = 1.0;
    fixDef.friction = 0;
    fixDef.restitution = 0;

    var bodyDef = new b2BodyDef();

    //create body border
    for ( var i = 0; i < verts.length - 1; i++ ) {
      //create ground
      bodyDef.type = b2Body.b2_staticBody;
      bodyDef.position.x = 255;
      bodyDef.position.y = 70;
      fixDef.shape = new b2PolygonShape();

      var vert1 = new b2Vec2( verts[i][0], verts[i][1] );
      var vert2 = new b2Vec2( verts[i + 1][0], verts[i + 1][1] );

      fixDef.shape = new b2PolygonShape;
      fixDef.shape.SetAsEdge( vert1, vert2 );
      //fixDef.shape.SetAsBox(10, 0.5);
      var body = world.CreateBody( bodyDef );
      body.CreateFixture( fixDef );
    }


    //create some objects
    bodyDef.type = b2Body.b2_dynamicBody;
    for ( var i = 0; i < 20; ++i ) {
      fixDef.shape = new b2CircleShape( 7 //radius
      );
      bodyDef.position.x = Math.random() * 100 + 330;
      bodyDef.position.y = Math.random() * 200 + 150;
      var body = world.CreateBody( bodyDef );
      body.CreateFixture( fixDef );
      bodies.push( body );
    }

    //setup debug draw
    var debugDraw = new b2DebugDraw();
    debugDraw.SetSprite( document.getElementById( "canvas" ).getContext( "2d" ) );
    debugDraw.SetDrawScale( 1.0 );
    debugDraw.SetFillAlpha( 0.3 );
    debugDraw.SetLineThickness( 1.0 );
    debugDraw.SetFlags( b2DebugDraw.e_shapeBit | b2DebugDraw.e_jointBit );
    world.SetDebugDraw( debugDraw );
    window.setInterval( update, 1000 / 60 );
  }


  function update() {
    //window.body0.ApplyForce( new b2Vec2( 10000, 10000 ), window.body0.GetWorldCenter() );
    applyForces();
    world.Step( 1 / 2 //frame-rate
        , 10//velocity iterations
        , 10 //position iterations
    );
    world.DrawDebugData();
    world.ClearForces();
    console.log( bodies[0].GetWorldCenter() )
  }

  function applyForces() {
    bodies.forEach( function( entry ) {
      var f = calculateSumOfForces( entry );
      entry.ApplyForce( f, entry.GetWorldCenter() );

    } );
  }

  function calculateSumOfForces( body ) {
    var sumVector = new b2Vec2();
    bodies.forEach( function( entry ) {
      if ( body != entry ) {
        sumVector.Add( getForce( body, entry ) );
      }
    } );
    return sumVector;
  }
  ;

  function getForce( body, entry ) {

    var k = 5;
    var force = new b2Vec2( 0, 0 );
    var distanceVector = body.GetWorldCenter().Copy();
    distanceVector.Subtract( entry.GetWorldCenter() );
    var distanceLength = distanceVector.Length();
    if ( distanceLength > 1 ) {
      distanceVector.Multiply( k / Math.pow( distanceLength, 2.5 ) );
      var max = 0.05;
      if ( distanceVector.Length() > max ) {
        distanceVector.Multiply( max / distanceVector.Length() );
      }
      force = distanceVector;
    }
    force.Multiply( 100 )
    return force;
  }
  ;

</script>

</html>